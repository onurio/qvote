#!/bin/sh
# QVote pre-commit hook
# Run linting, formatting check, type checking, tests, and coverage checks before commit

echo "Running QVote pre-commit checks..."

# Run the check:all task which includes lint, format check, type check, and tests
deno task check:all

# Capture the exit code
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
  echo "❌ Pre-commit checks failed! Please fix the issues before committing."
  exit $EXIT_CODE
fi

echo "Checking code coverage..."

# Set minimum coverage thresholds
MIN_LINE_COVERAGE=81.0
MIN_BRANCH_COVERAGE=70.0

# Run coverage and capture output
echo "Running coverage tests..."
COVERAGE_OUTPUT=$(deno task coverage 2>&1)

# Create a file with just the coverage summary
echo "$COVERAGE_OUTPUT" | grep "All files" > /tmp/coverage.txt

# Extract values using sed to clean ANSI color codes - column order is Branch % | Line %
BRANCH_COVERAGE=$(cat /tmp/coverage.txt | sed 's/\x1b\[[0-9;]*m//g' | awk -F'|' '{print $2}' | tr -d ' ')
LINE_COVERAGE=$(cat /tmp/coverage.txt | sed 's/\x1b\[[0-9;]*m//g' | awk -F'|' '{print $3}' | tr -d ' ')

# Fix the swapped values since our output shows them incorrectly
TEMP=$BRANCH_COVERAGE
BRANCH_COVERAGE=$LINE_COVERAGE
LINE_COVERAGE=$TEMP

echo "Current coverage: $LINE_COVERAGE% line, $BRANCH_COVERAGE% branch"
echo "Required coverage: $MIN_LINE_COVERAGE% line, $MIN_BRANCH_COVERAGE% branch"

# Convert to integers (multiply by 10 to handle one decimal place)
LC_INT=$(echo "$LINE_COVERAGE * 10" | awk '{printf "%d", $1}')
BC_INT=$(echo "$BRANCH_COVERAGE * 10" | awk '{printf "%d", $1}')
MIN_LC_INT=$(echo "$MIN_LINE_COVERAGE * 10" | awk '{printf "%d", $1}')
MIN_BC_INT=$(echo "$MIN_BRANCH_COVERAGE * 10" | awk '{printf "%d", $1}')

# Compare as integers
if [ "$LC_INT" -lt "$MIN_LC_INT" ]; then
  echo "❌ Line coverage is below the minimum threshold of $MIN_LINE_COVERAGE%."
  echo "   Current line coverage: $LINE_COVERAGE%"
  echo "Please add tests to increase coverage before committing."
  exit 1
fi

if [ "$BC_INT" -lt "$MIN_BC_INT" ]; then
  echo "❌ Branch coverage is below the minimum threshold of $MIN_BRANCH_COVERAGE%."
  echo "   Current branch coverage: $BRANCH_COVERAGE%"
  echo "Please add tests to increase coverage before committing."
  exit 1
fi

# Coverage has already been run and checked

echo "✅ Code coverage meets requirements!"
echo "✅ All pre-commit checks passed!"
exit 0